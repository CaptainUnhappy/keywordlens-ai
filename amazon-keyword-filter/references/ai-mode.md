# AI+MCP Mode - Complete Guide

## Overview

AI mode uses MCP vision analysis for semantic understanding of product similarity, replacing perceptual hash with features like color, style, material, and shape.

## Prerequisites

**必须使用 uv**：此 skill 要求使用 uv 进行环境管理。

```bash
# 安装 uv
# Windows:
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
# Linux/Mac:
curl -LsSf https://astral.sh/uv/install.sh | sh

# 在工作目录运行自动设置
cd /path/to/your/project
python .claude/skills/amazon-keyword-filter/scripts/setup_env.py
```

## Why AI Mode?

**Advantages**:
- Semantic understanding (not just pixel matching)
- Identifies visual features (color, style, material, shape)
- Customizable feature weights
- Visual grid for human review

**Trade-offs**:
- Requires MCP calls (cost consideration)
- Semi-automated (needs MCP integration)
- Slower than hash mode

## Complete Workflow

### Single Keyword Analysis

```bash
python scripts/analyze_keyword_with_ai.py "wireless earbuds" my_product.jpg
```

**What happens**:
1. Searches Amazon → Gets 20 image URLs
2. Downloads and merges → Creates 5×4 grid
3. Outputs MCP prompt for reference product
4. Outputs MCP prompt for merged grid
5. Calculates scores when MCP returns results

**Output directory**:
```
ai_analysis_results/wireless_earbuds_20260104_185023/
├── search_result.json      # Step 1: Amazon URLs
├── merged_grid.jpg         # Step 2: Grid image
└── analysis_result.json    # Step 5: Final scores
```

### Batch Keyword Analysis

```bash
python scripts/batch_analyze_with_ai.py keywords.xlsx my_product.jpg
```

**What happens**:
1. First run: Prompts for reference product MCP analysis
2. Save MCP result to `ai_batch_results/reference_analysis.json`
3. Rerun: Processes all keywords using shared reference
4. Each keyword: Search → Merge → MCP grid analysis
5. Saves progress to `batch_progress.json`

**Output directory**:
```
ai_batch_results/
├── reference_analysis.json     # Shared reference (1 MCP call)
├── batch_progress.json         # Resume support
├── batch_summary.json          # Final report
└── [keyword_dirs]/             # Per-keyword results
```

## MCP Integration

### Call 1: Analyze Reference Product

**Tool**: `zai-mcp-server__analyze_image`

**Input prompt** (auto-generated by script):
```
Analyze this product image and extract features:

1. Main color: Primary color tone
2. Style: modern/classic/sport/business/etc.
3. Key features: List 3-5 distinctive features
4. Material: plastic/metal/fabric/etc.
5. Shape: Overall shape description

Return JSON:
{
  "main_color": "...",
  "style": "...",
  "key_features": ["...", "..."],
  "material": "...",
  "shape": "...",
  "weights": {
    "color": 0.3,
    "style": 0.2,
    "features": 0.4,
    "shape": 0.1
  }
}

Image: my_product.jpg
```

**Example response**:
```json
{
  "main_color": "black",
  "style": "modern tech",
  "key_features": ["true wireless", "in-ear", "charging case", "touch control"],
  "material": "plastic + silicone",
  "shape": "bean-shaped earbud",
  "weights": {
    "color": 0.25,
    "style": 0.20,
    "features": 0.40,
    "shape": 0.15
  }
}
```

### Call 2: Analyze Merged Grid

**Tool**: `zai-mcp-server__analyze_image`

**Input prompt** (auto-generated):
```
This is a 4×5 grid with 20 Amazon products.

Reference product features:
- Color: black (weight 25%)
- Style: modern tech (weight 20%)
- Features: true wireless, in-ear, charging case (weight 40%)
- Shape: bean-shaped (weight 15%)

Analyze each grid item, calculate similarity to reference.

Return JSON:
{
  "similar_products": [
    {"position": 1, "similarity_score": 0.92, "reasons": ["...", "..."]},
    ...
  ],
  "match_count": <count where score >= 0.85>,
  "avg_similarity": <average>
}

Image: merged_grid.jpg
```

**Example response**:
```json
{
  "similar_products": [
    {
      "position": 1,
      "similarity_score": 0.92,
      "reasons": ["black color match", "bean shape", "charging case", "modern style"]
    },
    {
      "position": 5,
      "similarity_score": 0.87,
      "reasons": ["in-ear design", "charging case similar", "touch control"]
    }
  ],
  "match_count": 2,
  "avg_similarity": 0.895
}
```

## Feature Weighting

Customize weights in `reference_analysis.json`:

```json
{
  "weights": {
    "color": 0.4,      // Emphasize color matching
    "style": 0.1,      // De-emphasize style
    "features": 0.4,   // Emphasize functional features
    "shape": 0.1       // De-emphasize shape
  }
}
```

Total must sum to 1.0.

## Command-Line Options

### analyze_keyword_with_ai.py

```bash
python scripts/analyze_keyword_with_ai.py <keyword> <product_image> [options]

Options:
  --amazon-domain DOMAIN     Amazon domain (default: amazon.com)
  --max-products N           Max products to fetch (default: 20)
  --columns N                Grid columns (default: 5)
  --threshold FLOAT          Similarity threshold (default: 0.85)
  -o, --output DIR           Output directory
  --debug                    Enable debug mode
  --no-headless              Show browser window
  --no-ssl-verify            Disable SSL verification

Examples:
  python scripts/analyze_keyword_with_ai.py "earbuds" product.jpg
  python scripts/analyze_keyword_with_ai.py "earbuds" product.jpg --debug
  python scripts/analyze_keyword_with_ai.py "earbuds" product.jpg --columns 10
```

### batch_analyze_with_ai.py

```bash
python scripts/batch_analyze_with_ai.py <excel_file> <product_image> [options]

Options:
  --column NAME              Keyword column name (default: 关键词)
  --amazon-domain DOMAIN     Amazon domain
  --max-products N           Max products per keyword
  --columns N                Grid columns
  --threshold FLOAT          Similarity threshold
  -o, --output DIR           Output directory
  --cache FILE               Progress cache file
  --debug                    Enable debug mode
  --no-headless              Show browser window
  --no-ssl-verify            Disable SSL verification

Examples:
  python scripts/batch_analyze_with_ai.py keywords.xlsx product.jpg
  python scripts/batch_analyze_with_ai.py keywords.xlsx product.jpg --column "Search Term"
  python scripts/batch_analyze_with_ai.py keywords.xlsx product.jpg --debug
```

## Comparison: Hash vs AI Mode

| Feature | Hash Mode | AI Mode |
|---------|-----------|---------|
| Analysis method | Perceptual hash | MCP vision AI |
| Understanding | Pixel-level | Semantic-level |
| Identifies | Visual similarity | Color/style/material/shape |
| Automation | Full auto | Semi-auto (MCP) |
| Speed | Fast (seconds) | Slower (minutes) |
| Cost | Free | MCP API cost |
| MCP calls | 0 | 2 per keyword |
| Best for | Quick filtering | Precision analysis |

## Mixed Strategy (Recommended)

Combine both modes for optimal results:

```
┌─────────────────┐
│ 100 keywords    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Hash Mode       │ ← Fast initial filter (10 min)
│ → 30 keywords   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ AI Mode         │ ← Precision analysis (30 min)
│ → 10 quality    │
└─────────────────┘
```

This approach:
- Minimizes MCP costs (only 31 calls instead of 101)
- Maintains high precision for final selection
- Balances speed and accuracy

## Troubleshooting

### Script outputs MCP prompts but doesn't complete

**Solution**: Claude Code automatically calls MCP. If running manually:
1. Copy the MCP prompt from script output
2. Call `zai-mcp-server__analyze_image` with the prompt
3. Save JSON response to the appropriate file
4. Rerun script to continue

### Image download fails

**Solution**: Use `--no-ssl-verify` flag:
```bash
python scripts/analyze_keyword_with_ai.py "test" product.jpg --no-ssl-verify
```

### Want to see browser during search

**Solution**: Use `--debug --no-headless`:
```bash
python scripts/analyze_keyword_with_ai.py "test" product.jpg --debug --no-headless
```

### Batch processing interrupted

**Solution**: Progress is saved automatically. Just rerun:
```bash
python scripts/batch_analyze_with_ai.py keywords.xlsx product.jpg
```

The script skips already-processed keywords.

### Need different grid layout

**Solution**: Adjust columns (more columns = smaller images):
```bash
# Dense grid (10 columns)
python scripts/analyze_keyword_with_ai.py "test" product.jpg --columns 10

# Large images (3 columns)
python scripts/analyze_keyword_with_ai.py "test" product.jpg --columns 3
```

## Performance Metrics

| Keywords | MCP Calls | Estimated Cost | Time |
|----------|-----------|----------------|------|
| 1 | 2 | Minimal | 2-3 min |
| 10 | 11 | Low | 15-20 min |
| 100 | 101 | Medium | 2-3 hours |

Note: Batch mode shares 1 reference analysis across all keywords.

## Integration with Claude Code

When running scripts in Claude Code:

1. **Script outputs MCP prompt** → Claude sees it
2. **Claude automatically calls MCP** → `zai-mcp-server__analyze_image`
3. **MCP returns JSON** → Claude parses it
4. **Script continues** → Calculates final scores

This seamless integration makes AI mode fully automated when using Claude Code.

## File Formats

### search_result.json
```json
{
  "keyword": "wireless earbuds",
  "amazon_domain": "amazon.com",
  "image_urls": ["url1", "url2", ...],
  "count": 20
}
```

### reference_analysis.json
```json
{
  "analyzed": true,
  "image_path": "product.jpg",
  "main_color": "black",
  "style": "modern tech",
  "key_features": ["feature1", "feature2"],
  "material": "plastic",
  "shape": "bean-shaped",
  "weights": {"color": 0.25, "style": 0.2, "features": 0.4, "shape": 0.15}
}
```

### analysis_result.json
```json
{
  "keyword": "wireless earbuds",
  "timestamp": "20260104_185023",
  "steps": {
    "search": {"success": true, "count": 20},
    "merge": {"success": true, "path": "merged_grid.jpg"},
    "reference_analysis": {...},
    "similarity_analysis": {...}
  },
  "summary": {
    "total_products": 20,
    "match_count": 3,
    "avg_similarity": 0.88,
    "max_similarity": 0.92,
    "is_qualified": true,
    "threshold": 0.85
  }
}
```

## Next Steps

1. **Test with one keyword**: `python scripts/analyze_keyword_with_ai.py "test" product.jpg`
2. **Review outputs**: Check `ai_analysis_results/` directory
3. **Adjust weights**: Edit feature weights in reference analysis
4. **Batch process**: Run on full keyword list
5. **Compare modes**: Try both hash and AI modes to find optimal strategy
